# Firebase Messaging Configuration Guide

This guide explains how to configure and use Firebase Cloud Messaging (FCM) for background notifications in your Flutter plugin project.

## Table of Contents

1. [Prerequisites](#prerequisites)
2. [Project Setup](#project-setup)
3. [Configuration](#configuration)
4. [Usage](#usage)
5. [Testing](#testing)
6. [Integration with CallKit](#integration-with-callkit)
7. [Troubleshooting](#troubleshooting)

## Prerequisites

- Firebase project created and configured
- Google Services files added to your project:
  - `android/app/google-services.json`
  - `ios/Runner/GoogleService-Info.plist`
- Firebase Console access for testing notifications

## Project Setup

### Dependencies

The following dependencies are required in your `pubspec.yaml`:

```yaml
dependencies:
  firebase_core: ^3.15.0
  firebase_messaging: ^15.2.8
  flutter_local_notifications: ^18.0.1
```

### Firebase Options

Ensure you have the `firebase_options.dart` file generated by FlutterFire CLI:

```bash
flutter pub global activate flutterfire_cli
flutterfire configure
```

## Configuration

### 1. Main Application Setup

The `main.dart` file is configured to initialize Firebase and FCM:

```dart
import 'package:firebase_core/firebase_core.dart';
import 'package:firebase_messaging/firebase_messaging.dart';
import 'services/firebase_messaging_service.dart';
import 'firebase_options.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();

  // Initialize Firebase
  await Firebase.initializeApp(
    options: DefaultFirebaseOptions.currentPlatform,
  );

  // Set background message handler
  FirebaseMessaging.onBackgroundMessage(firebaseMessagingBackgroundHandler);

  // Initialize Firebase Messaging
  await FirebaseMessagingService().initialize();

  runApp(const MyApp());
}
```

### 2. Android Configuration

#### Permissions (`android/app/src/main/AndroidManifest.xml`)

```xml
<manifest xmlns:android="http://schemas.android.com/apk/res/android">
    <!-- Internet permission for Firebase -->
    <uses-permission android:name="android.permission.INTERNET" />
    <!-- Notification permissions -->
    <uses-permission android:name="android.permission.WAKE_LOCK" />
    <uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED" />
    <uses-permission android:name="android.permission.VIBRATE" />
    <!-- Firebase Messaging permissions -->
    <uses-permission android:name="com.google.android.c2dm.permission.RECEIVE" />
    <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />

    <application>
        <!-- Your existing application configuration -->

        <!-- Firebase Messaging Service -->
        <service
            android:name="com.google.firebase.messaging.FirebaseMessagingService"
            android:exported="false">
            <intent-filter>
                <action android:name="com.google.firebase.MESSAGING_EVENT" />
            </intent-filter>
        </service>

        <!-- Default notification settings -->
        <meta-data
            android:name="com.google.firebase.messaging.default_notification_icon"
            android:resource="@mipmap/ic_launcher" />
        <meta-data
            android:name="com.google.firebase.messaging.default_notification_color"
            android:resource="@android:color/holo_blue_bright" />
        <meta-data
            android:name="com.google.firebase.messaging.default_notification_channel_id"
            android:value="high_importance_channel" />
    </application>
</manifest>
```

### 3. iOS Configuration

#### Info.plist (`ios/Runner/Info.plist`)

Add background modes for remote notifications:

```xml
<key>UIBackgroundModes</key>
<array>
    <string>background-fetch</string>
    <string>remote-notification</string>
</array>

<key>FirebaseAppDelegateProxyEnabled</key>
<false/>
```

#### Push Notification Capability

1. Open your iOS project in Xcode
2. Go to Project Settings → Signing & Capabilities
3. Add "Push Notifications" capability
4. Add "Background Modes" capability and check:
   - Background fetch
   - Remote notifications

## Usage

### Firebase Messaging Service

The `FirebaseMessagingService` class handles all FCM operations:

```dart
// Get the service instance
final messagingService = FirebaseMessagingService();

// Get FCM token
String? token = messagingService.fcmToken;

// Subscribe to topics
await messagingService.subscribeToTopic('news');

// Unsubscribe from topics
await messagingService.unsubscribeFromTopic('news');

// Clear all notifications
await messagingService.clearAllNotifications();
```

### Message Handling

The service handles messages in different app states:

1. **Foreground**: App is open and visible

   - Shows local notification
   - Processes message data immediately

2. **Background**: App is minimized

   - Handled by background message handler
   - Can update app data but cannot show UI

3. **Terminated**: App is completely closed
   - Message is received when app is launched
   - Handled via `getInitialMessage()`

### Custom Message Processing

Modify the `_processMessageData` method in `FirebaseMessagingService` to handle your specific message types:

```dart
Future<void> _processMessageData(RemoteMessage message) async {
  final data = message.data;

  if (data.containsKey('type')) {
    switch (data['type']) {
      case 'call':
        await _handleCallNotification(data);
        break;
      case 'message':
        await _handleMessageNotification(data);
        break;
      // Add your custom types here
    }
  }
}
```

## Testing

### 1. Using Firebase Console

1. Go to Firebase Console → Cloud Messaging
2. Click "Send your first message"
3. Enter notification title and text
4. Select your app as target
5. Send the test message

### 2. Using FCM Token

1. Copy the FCM token from the app (using the Firebase Messaging widget)
2. Use Firebase Console or any FCM testing tool
3. Send targeted messages to specific devices

### 3. Testing Different App States

Test notifications in all app states:

- **Foreground**: App open and visible
- **Background**: App minimized (home button pressed)
- **Terminated**: App completely closed (swiped away)

### 4. Topic Testing

```bash
# Send to topic using curl
curl -X POST "https://fcm.googleapis.com/fcm/send" \
-H "Authorization: key=YOUR_SERVER_KEY" \
-H "Content-Type: application/json" \
-d '{
  "to": "/topics/test_topic",
  "notification": {
    "title": "Test Topic Message",
    "body": "This is a test message sent to a topic"
  },
  "data": {
    "type": "topic_test",
    "timestamp": "2024-01-01T00:00:00Z"
  }
}'
```

## Integration with CallKit

### Call Notifications

To integrate FCM with your CallKit plugin for incoming calls:

```dart
Future<void> _handleCallNotification(Map<String, dynamic> data) async {
  // Extract call data
  final callerId = data['caller_id'];
  final callerName = data['caller_name'];
  final callId = data['call_id'];

  // Create call data
  final callData = CallData(
    id: callId,
    callerName: callerName,
    phoneNumber: callerId,
    isVideo: data['is_video'] == 'true',
    avatarUrl: data['avatar_url'],
  );

  // Show incoming call
  await VCallkitPlugin().showIncomingCall(callData);
}
```

### Message Format for Calls

Send FCM messages with this format for call notifications:

```json
{
  "to": "FCM_TOKEN_HERE",
  "notification": {
    "title": "Incoming Call",
    "body": "John Doe is calling you"
  },
  "data": {
    "type": "call",
    "call_id": "unique_call_id",
    "caller_id": "+1234567890",
    "caller_name": "John Doe",
    "is_video": "false",
    "avatar_url": "https://example.com/avatar.jpg"
  }
}
```

## Troubleshooting

### Common Issues

1. **No FCM Token Generated**

   - Check internet connection
   - Verify Firebase configuration
   - Ensure app permissions are granted

2. **Background Messages Not Received**

   - Verify background message handler is set
   - Check device battery optimization settings
   - Ensure app is not force-killed

3. **iOS Notifications Not Working**

   - Verify Push Notification capability is enabled
   - Check provisioning profile includes push notifications
   - Ensure APNs certificate is configured in Firebase

4. **Android Notification Channel Issues**
   - Verify notification channel is created
   - Check target SDK version compatibility
   - Ensure channel importance is set correctly

### Debug Tips

1. **Enable Firebase Debug Logging**:

   ```bash
   # Android
   adb shell setprop log.tag.FirebaseMessaging DEBUG

   # iOS - Add to Info.plist
   <key>FirebaseDebugEnabled</key>
   <true/>
   ```

2. **Check FCM Registration**:

   ```dart
   final settings = await FirebaseMessaging.instance.getNotificationSettings();
   print('Notification settings: ${settings.authorizationStatus}');
   ```

3. **Monitor Background Handler**:
   ```dart
   @pragma('vm:entry-point')
   Future<void> firebaseMessagingBackgroundHandler(RemoteMessage message) async {
     print('Background message: ${message.messageId}');
     // Add your background handling logic
   }
   ```

### Performance Considerations

1. **Token Management**:

   - Cache tokens locally to avoid unnecessary requests
   - Send tokens to your server only when changed
   - Handle token refresh events properly

2. **Message Processing**:

   - Keep background message handler lightweight
   - Avoid heavy computations in foreground handlers
   - Use local storage for background data persistence

3. **Notification Optimization**:
   - Use appropriate notification channels
   - Set proper notification priorities
   - Handle notification grouping for multiple messages

## Best Practices

1. **Security**:

   - Never expose server keys in client code
   - Validate message data before processing
   - Use HTTPS for all server communications

2. **User Experience**:

   - Request permissions at appropriate times
   - Provide clear notification content
   - Handle notification actions gracefully

3. **Testing**:

   - Test on physical devices (not just emulators)
   - Test all app states (foreground/background/terminated)
   - Verify notification behavior across different Android versions

4. **Monitoring**:
   - Log important FCM events
   - Monitor token refresh rates
   - Track notification delivery and engagement

## Additional Resources

- [Firebase Cloud Messaging Documentation](https://firebase.google.com/docs/cloud-messaging)
- [Flutter Firebase Messaging Plugin](https://pub.dev/packages/firebase_messaging)
- [Flutter Local Notifications Plugin](https://pub.dev/packages/flutter_local_notifications)
- [Firebase Console](https://console.firebase.google.com/)

---

This guide provides a complete setup for Firebase Cloud Messaging with background notification support. The implementation handles all app states and provides a robust foundation for push notification functionality in your Flutter plugin project.
